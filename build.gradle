apply plugin: 'com.github.ben-manes.versions'
apply plugin: "idea-utils"
apply plugin: "com.jetbrains.python.envs"

buildscript {
    repositories {
        mavenCentral()
        maven { url "https://oss.sonatype.org/content/repositories/snapshots/" }
        jcenter()
        maven { url "https://jitpack.io" }
        maven { url "https://plugins.gradle.org/m2/" }
        maven { url "https://repo.cuba-platform.com/content/groups/work/" }
    }
    dependencies {
        classpath 'de.richsource.gradle.plugins:gwt-gradle-plugin:0.6'
        classpath 'com.android.tools.build:gradle:1.0.0'
        classpath 'org.robovm:robovm-gradle-plugin:1.9.0'
        classpath 'net.sf.proguard:proguard-gradle:6.2.0'
        classpath 'com.github.ben-manes:gradle-versions-plugin:0.11.3'
        classpath 'com.github.rodionmoiseev.gradle.plugins:idea-utils:0.4-rc1'
        classpath 'gradle.plugin.com.jetbrains.python:gradle-python-envs:0.0.31'
    }
}

allprojects {
    apply plugin: "idea"

    version = '1.0'
    ext {
        appName = 'BrainOut'
        gdxVersion = '1.11.0'
        localGdxVersion = '1.11.1-dev'
        roboVMVersion = '2.1.0'
        box2DLightsVersion = '1.5'
        ashleyVersion = '1.4.0'
        aiVersion = '1.9.5-dev'
        anthillRuntimeVersion = '0.2.10'
        anthillServerRuntimeVersion = '0.2.0'
        gdxControllersVersion = '2.2.2'
    }

    repositories {
        mavenCentral()
        maven { url "https://oss.sonatype.org/content/repositories/snapshots/" }
        maven { url "https://oss.sonatype.org/content/repositories/releases/" }
        maven { url "https://jitpack.io" }
    }
}

/*

project(":android") {
    apply plugin: "android"

    configurations { natives }

    dependencies {
        implementation project(":client")
        implementation "com.badlogicgames.gdx:gdx-backend-android:$gdxVersion"
        natives "com.badlogicgames.gdx:gdx-platform:$gdxVersion:natives-armeabi"
        natives "com.badlogicgames.gdx:gdx-platform:$gdxVersion:natives-armeabi-v7a"
        natives "com.badlogicgames.gdx:gdx-platform:$gdxVersion:natives-x86"
        implementation "com.badlogicgames.gdx:gdx-box2d:$gdxVersion"
        natives "com.badlogicgames.gdx:gdx-box2d-platform:$gdxVersion:natives-armeabi"
        natives "com.badlogicgames.gdx:gdx-box2d-platform:$gdxVersion:natives-armeabi-v7a"
        natives "com.badlogicgames.gdx:gdx-box2d-platform:$gdxVersion:natives-x86"
    }

    repositories {
        mavenLocal()
    }
}

project(":ios") {
    apply plugin: "java"
    apply plugin: "robovm"

    configurations { natives }

    dependencies {
        implementation project(":client")
        implementation "org.robovm:robovm-rt:$roboVMVersion"
        implementation "org.robovm:robovm-cocoatouch:$roboVMVersion"
        implementation "com.badlogicgames.gdx:gdx-backend-robovm:$gdxVersion"
        implementation "com.badlogicgames.gdx:gdx-box2d:$gdxVersion"
        natives "com.badlogicgames.gdx:gdx-platform:$gdxVersion:natives-ios"
        natives "com.badlogicgames.gdx:gdx-box2d-platform:$gdxVersion:natives-ios"
    }

    repositories {
        mavenLocal()
    }
}

*/

project(":core") {
    apply plugin: "java"
    apply plugin: "java-library"

    dependencies {
        api ("com.github.anthill-platform:anthill-runtime-java:$anthillRuntimeVersion") {
            exclude group: 'com.mashape.unirest', module: 'unirest-java'
            api "com.mashape.unirest:unirest-java:1.4.9"
        }

        api "com.github.desertkun.infomas-asl:annotation-detector:3.1-dev"

        api ("com.github.desertkun:kryonet:2.22.0-RC7") {
            exclude group: 'com.esotericsoftware', module: 'kryo'
        }
        api "com.esotericsoftware:kryo:5.4.0"

        api "org.json:json:20180130"
        api "com.github.desertkun.libgdx:gdx:$localGdxVersion"
        api ("com.badlogicgames.gdx:gdx-box2d:$gdxVersion") {
            exclude group: 'com.badlogicgames.gdx', module: 'gdx'
        }
    }

    repositories {
        mavenLocal()
    }
}

project(":client") {
    apply plugin: "java"
    apply plugin: "java-library"

    dependencies {
        implementation "com.beust:jcommander:1.48"
        implementation "com.mashape.unirest:unirest-java:1.4.9"
        implementation ("com.badlogicgames.box2dlights:box2dlights:$box2DLightsVersion") {
            exclude group: 'com.badlogicgames.gdx', module: 'gdx'
        }
        api project(":core")
        implementation ("com.badlogicgames.gdx-controllers:gdx-controllers-core:$gdxControllersVersion") {
            exclude group: 'com.badlogicgames.gdx', module: 'gdx'
            implementation "com.github.desertkun.libgdx:gdx:$localGdxVersion"
        }
        implementation ("com.badlogicgames.gdx:gdx-freetype:$gdxVersion") {
            exclude group: 'com.badlogicgames.gdx', module: 'gdx'
        }
        implementation ("com.badlogicgames.gdx:gdx-tools:$gdxVersion") {
            exclude group: 'com.badlogicgames.gdx', module: 'gdx-backend-lwjgl'
            exclude group: 'com.badlogicgames.gdx', module: 'gdx'
        }
    }

    repositories {
        mavenLocal()
    }
}


project(":desktop") {
    apply plugin: "java"


    dependencies {
        implementation project(":client")
        implementation ("com.badlogicgames.gdx:gdx-backend-lwjgl3:$gdxVersion") {
            exclude group: 'com.badlogicgames.gdx', module: 'gdx'
        }
        implementation "com.badlogicgames.gdx:gdx-platform:$gdxVersion:natives-desktop"
        implementation "com.badlogicgames.gdx:gdx-box2d-platform:$gdxVersion:natives-desktop"
        implementation ("com.badlogicgames.gdx-controllers:gdx-controllers-desktop:$gdxControllersVersion") {
            exclude group: 'com.badlogicgames.gdx', module: 'gdx'
            implementation "com.github.desertkun.libgdx:gdx:$localGdxVersion"
        }
        implementation "com.badlogicgames.gdx:gdx-freetype-platform:$gdxVersion:natives-desktop"
    }

    repositories {
        mavenLocal()
    }
}

project(":steam") {
    apply plugin: "java"


    dependencies {
        implementation project(":desktop")
        implementation project(":client")
        implementation files('libs/steamworks4j-1.10.0-SNAPSHOT.jar')
        implementation files('libs/steamworks4j-gdx-1.10.0-SNAPSHOT.jar')
        implementation files('libs/steamworks4j-lwjgl3-1.10.0-SNAPSHOT.jar')
    }
}

project(":server") {
    apply plugin: "java"

    dependencies {
        implementation ("com.github.anthill-platform:anthill-runtime-java:$anthillRuntimeVersion") {
            exclude group: 'com.mashape.unirest', module: 'unirest-java'
            implementation "com.mashape.unirest:unirest-java:1.4.9"
        }
        implementation "com.github.anthill-platform:anthill-runtime-java-server:$anthillServerRuntimeVersion"
        implementation project(":core")
        implementation "com.beust:jcommander:1.48"
        implementation "com.badlogicgames.gdx:gdx-platform:$gdxVersion:natives-desktop"
        implementation "com.badlogicgames.gdx:gdx-backend-lwjgl3:$gdxVersion"
        implementation "com.badlogicgames.gdx:gdx-box2d-platform:$gdxVersion:natives-desktop"
        implementation "com.sun.net.httpserver:http:20070405"
    }
}

import org.apache.tools.ant.taskdefs.condition.Os

def accessToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1bm0iOiJkZXY6YnJhaW5vdXRfc2VydmVyIiwiYWNjIjoiNCIsImdtcyI6IjEiLCJzY28iOiJldmVudF9qb2luLGV2ZW50X2xlYXZlLHByb21vLHByb2ZpbGUsbWVzc2FnZV9saXN0ZW4scHJvZmlsZV93cml0ZSxncm91cCxldmVudF93cml0ZSxnYW1lX2Jhbixncm91cF93cml0ZSxncm91cF9jcmVhdGUscGFydHlfY2xvc2UsZ2FtZV9tdWx0aSxtYXJrZXRfdXBkYXRlX2l0ZW0sc3RvcmVfb3JkZXIscHJvZmlsZV9wcml2YXRlLG1lc3NhZ2VfYXV0aG9yaXRhdGl2ZSxsYl9hcmJpdHJhcnlfYWNjb3VudCxldmVudF9wcm9maWxlX3dyaXRlLHJlcG9ydF91cGxvYWQsZ2FtZSxtYXJrZXRfcG9zdF9vcmRlciIsImlhdCI6IjE2ODEwNDk0OTUiLCJleHAiOiIxNjg2MjMzNDk1IiwidWlkIjoiYzQ1NWI1OWMtNTkyZi00N2U5LTljYzYtYjAxOGEwNzc1NzEwIn0.iSSlk5yfBVFbxSGaJ5fNJpaIEwV-P-ObRC1awIy9__ajxRmpiixGAE2_9AS9QbFaJ6Gy1DT21FCt_O8iFnzSsQOsCv4Bibcr0zec2OctW23Ylpl5w8ed7wZW7zGSR_-_6YCdzcTr3OjSVtGW2pvLiIg3f36pDK24B_AR2grL3eD5hnidkhi3410HiMMoK-o6cnW-HZeuAIB8Hg9-llRuNrxD2jgG8dw_7BwwT6rKiJGoPJqte9K9n11Vfxjue7pZpCarmfMt53uJzNgACBcmW98UP_KUY_9ctq53uvRc0L0MA-Oce1KVmMFeSNxsDIWDg4DpXEETfommwHGn2alONg'
def discoveryServices = '{"profile":"https://profile-valpha-2.brainout.org","login":"https://login-valpha-2.brainout.org","message":"https://message-valpha-2.brainout.org","event":"https://event-valpha-2.brainout.org","leaderboard":"https://leaderboard-valpha-2.brainout.org","social":"https://social-valpha-2.brainout.org","static":"https://static-valpha-2.brainout.org","game":"https://game-valpha-2.brainout.org","store":"https://store-valpha-2.brainout.org","report":"https://report-valpha-2.brainout.org","market":"https://market-valpha-2.brainout.org"}'

idea {
    project {
        jdkName = '1.8'
        languageLevel = '1.8'

        vcs {
            vcs = 'Git'
            directory = project.projectDir.toString()
        }

        runConfigurations {
            server {
                type = 'Application'
                name = 'Server Alpha'

                mainClass = 'com.desertkun.brainout.Main'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''
                programArguments = 'no 36555,36556,36557 --settings server-settings.json --maps maps-set.json'
                env = [
                    'login_access_token': accessToken,
                    'JAVA_LIBRARY_PATH': '/opt/local/lib',
                    'discovery_services': discoveryServices
                ]
                module = project(':server')
                workingDirectory = new File(project.projectDir.toString(), 'bin/server')
            }
            serverOffline {
                type = 'Application'
                name = 'Server Offline'

                mainClass = 'com.desertkun.brainout.Main'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''
                programArguments = 'no 36555,36556,36557 --settings server-settings.json --maps maps-set.json --offline'
                env = [
                    'login_access_token': accessToken,
                    'JAVA_LIBRARY_PATH': '/opt/local/lib',
                    'discovery_services': discoveryServices
                ]
                module = project(':server')
                workingDirectory = new File(project.projectDir.toString(), 'bin/server')
            }
            serverEditor {
                type = 'Application'
                name = 'Server Editor Alpha'

                mainClass = 'com.desertkun.brainout.Main'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''
                env = [
                    'login_access_token': accessToken,
                    'JAVA_LIBRARY_PATH': '/opt/local/lib',
                    'discovery_services': discoveryServices
                ]
                programArguments = '--mode editor --settings server-editor.json'
                module = project(':server')
                workingDirectory = new File(project.projectDir.toString(), 'bin/server')
            }
            serverEditorOffline {
                type = 'Application'
                name = 'Server Editor Offline'

                mainClass = 'com.desertkun.brainout.Main'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''
                env = [
                    'login_access_token': accessToken,
                    'JAVA_LIBRARY_PATH': '/opt/local/lib',
                    'discovery_services': discoveryServices
                ]
                programArguments = '--mode editor --settings server-editor.json --offline'
                module = project(':server')
                workingDirectory = new File(project.projectDir.toString(), 'bin/server')
            }
            serverLobby {
                type = 'Application'
                name = 'Server Lobby Alpha'

                mainClass = 'com.desertkun.brainout.Main'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''
                env = [
                        'login_access_token': accessToken,
                        'JAVA_LIBRARY_PATH': '/opt/local/lib',
                        'discovery_services': discoveryServices
                ]
                programArguments = '--mode lobby --settings server-lobby.json'
                module = project(':server')
                workingDirectory = new File(project.projectDir.toString(), 'bin/server')
            }
            serverLobbyOffline {
                type = 'Application'
                name = 'Server Lobby Offline'

                mainClass = 'com.desertkun.brainout.Main'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''
                env = [
                        'login_access_token': accessToken,
                        'JAVA_LIBRARY_PATH': '/opt/local/lib',
                        'discovery_services': discoveryServices
                ]
                programArguments = '--mode lobby --settings server-lobby.json --offline'
                module = project(':server')
                workingDirectory = new File(project.projectDir.toString(), 'bin/server')
            }
            serverFree {
                type = 'Application'
                name = 'Server Free Alpha'

                mainClass = 'com.desertkun.brainout.Main'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''
                env = [
                        'login_access_token': accessToken,
                        'JAVA_LIBRARY_PATH': '/opt/local/lib',
                        'discovery_services': discoveryServices
                ]
                programArguments = '--mode free --settings server-free.json --map freeplay-maps.shuffle'
                module = project(':server')
                workingDirectory = new File(project.projectDir.toString(), 'bin/server')
            }
            serverFreeOffline {
                type = 'Application'
                name = 'Server Free Offline'

                mainClass = 'com.desertkun.brainout.Main'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''
                env = [
                        'login_access_token': accessToken,
                        'JAVA_LIBRARY_PATH': '/opt/local/lib',
                        'discovery_services': discoveryServices
                ]
                programArguments = '--mode free --settings server-free.json --map freeplay-maps.shuffle --offline'
                module = project(':server')
                workingDirectory = new File(project.projectDir.toString(), 'bin/server')
            }
            steam {
                type = 'Application'
                name = 'Steam'

                mainClass = 'com.desertkun.brainout.desktop.SteamLauncher'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''

                programArguments = ''
                module = project(':steam')
                workingDirectory = new File(project.projectDir.toString(), 'bin/client')
            }
            desktop {
                type = 'Application'
                name = 'Desktop Alpha'

                mainClass = 'com.desertkun.brainout.desktop.DesktopLauncher'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''

                programArguments = ''
                module = project(':desktop')
                workingDirectory = new File(project.projectDir.toString(), 'bin/client')
            }
            desktopOffline {
                type = 'Application'
                name = 'Desktop Offline Unsafe'

                mainClass = 'com.desertkun.brainout.desktop.DesktopLauncher'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''

                programArguments = '--offline --unsafe'
                module = project(':desktop')
                workingDirectory = new File(project.projectDir.toString(), 'bin/client')
            }
            desktopLocal {
                type = 'Application'
                name = 'Desktop Local Alpha'

                mainClass = 'com.desertkun.brainout.desktop.DesktopLauncher'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''

                programArguments = '--connect brainout://bG9jYWxob3N0OzM2NTU1OzM2NTU2OzM2NTU3'
                module = project(':desktop')
                workingDirectory = new File(project.projectDir.toString(), 'bin/client')
            }
            desktopLocalOffline {
                type = 'Application'
                name = 'Desktop Local Offline Unsafe'

                mainClass = 'com.desertkun.brainout.desktop.DesktopLauncher'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''

                programArguments = '--connect brainout://bG9jYWxob3N0OzM2NTU1OzM2NTU2OzM2NTU3 --offline --unsafe'
                module = project(':desktop')
                workingDirectory = new File(project.projectDir.toString(), 'bin/client')
            }
            desktopLocal2 {
                type = 'Application'
                name = 'Desktop Local 2 Alpha'

                mainClass = 'com.desertkun.brainout.desktop.DesktopLauncher'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''

                programArguments = '--connect brainout://bG9jYWxob3N0OzM2NTU1OzM2NTU2OzM2NTU3'
                env = [
                    "DESKTOP_PROFILE_NAME": "profile-2"
                ]
                module = project(':desktop')
                workingDirectory = new File(project.projectDir.toString(), 'bin/client')
            }
            desktopLocal2Offline {
                type = 'Application'
                name = 'Desktop Local 2 Offline Unsafe'

                mainClass = 'com.desertkun.brainout.desktop.DesktopLauncher'
                vmOptions = Os.isFamily(Os.FAMILY_MAC) ? '-XstartOnFirstThread' : ''

                programArguments = '--connect brainout://bG9jYWxob3N0OzM2NTU1OzM2NTU2OzM2NTU3 --offline --unsafe'
                env = [
                    "DESKTOP_PROFILE_NAME": "profile-2"
                ]
                module = project(':desktop')
                workingDirectory = new File(project.projectDir.toString(), 'bin/client')
            }
        }
    }
}

envs {
    bootstrapDirectory = new File(buildDir, 'bootstrap')
    envsDirectory = new File(buildDir, 'envs')

    zipRepository = new URL("https://cdn.brainout.org/python/")
    shouldUseZipsFromRepository = Os.isFamily(Os.FAMILY_WINDOWS)

    python "python3_64", "3.10.0", ["PyCryptodome", "git+https://github.com/desertkun/hjson-py", "cffi"]
}

task make_data_client(type: Exec, dependsOn: 'build_envs') {
    workingDir "${project.projectDir}/scripts"
    commandLine Os.isFamily(Os.FAMILY_WINDOWS) ? "${buildDir}/bootstrap/python3_64/python.exe" : "${buildDir}/bootstrap/python3_64/bin/python3", 'make_data.py', 'client'
}

task make_data_server(type: Exec, dependsOn: 'build_envs') {
    workingDir "${project.projectDir}/scripts"
    commandLine Os.isFamily(Os.FAMILY_WINDOWS) ? "${buildDir}/bootstrap/python3_64/python.exe" : "${buildDir}/bootstrap/python3_64/bin/python3", 'make_data.py', 'server'
}

task make_data() {
    dependsOn 'make_data_client', 'make_data_server'
}
